<dom-module id="story-card">
  <style>
    :host {
      display: block;
      position: relative;
      box-sizing: border-box;
      background-color: #fff;
      padding: 0.5em;
      margin-bottom: 1em;
      border-radius: 2px;
      overflow: hidden;

      @apply(--shadow-elevation-2dp);
      @apply(--shadow-transition);

      -webkit-user-select: all;
      -moz-user-select: all;
      -ms-user-select: all;
      user-select: all;
    }

    :host([scrollable]) {
      overflow: auto;
    }

    :host([disable-text-selection]) {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #emptyLabel {
      color: var(--paper-grey-400);
      border: none;
    }

    .markdown-html h1, h2, h3, h4, h5, h6 {
      margin: 0.25em 0;
    }

    .markdown-html h2, h3, h4 {
      border-bottom: 1px solid var(--paper-grey-300);
    }

    .markdown-html img {
      max-width: 100%;
    }

    :host([selected]) {
      @apply(--shadow-elevation-6dp);
    }

  </style>
  <template>
    <firebase-document
      data="{{story}}"
      location="[[_cardStoryLocation(firebaseName, card)]]">
    </firebase-document>
    <marked-element markdown="[[story.markdown]]">
      <div class="markdown-html"></div>
    </marked-element>
    <template is="dom-if" if="[[!story.markdown]]">
      <h4 id="emptyLabel">Empty card...</h4>
    </template>
  </template>
</dom-module>
<script>
Polymer({
  is: 'story-card',

  behaviors: [
    Polymer.IronControlState
  ],

  properties: {
    firebaseName: {
      type: String
    },

    story: {
      type: Object,
      notify: true
    },

    card: {
      type: Object,
      notify: true,
      observer: '_cardChanged'
    },

    selected: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },

    dormant: {
      type: Boolean,
      value: false
    },

    disableTextSelection: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },

    scrollable: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    }
  },

  listeners: {
    'tap': '_onTap',
    'down': '_onDown',
    'up': '_onUp',
    'track': '_onTrack'
  },

  _cardChanged: function() {
    console.log('####', 'CARD CHANGED', arguments, this);
  },

  created: function() {
    this._awaitingDoubleTap = null;
    this._awaitingLongPress = null;
  },

  edit: function() {
    this.fire('edit-story', {
      story: this.card.story,
      relatedCard: this
    });
  },

  _cardStoryLocation: function(firebaseName, card) {
    return 'https://' + firebaseName + '.firebaseio.com/stories/' + card.story;
  },

  _onDown: function(event) {
    if (this.dormant) {
      return;
    }

    if (this._awaitingLongPress != null) {
      this.cancelAsync(this._awaitingLongPress);
    }

    this._awaitingLongPress = this.async(function() {
      this._onLongPress(event);
    }, 200);
  },

  _onUp: function() {
    if (this._awaitingLongPress != null) {
      this.cancelAsync(this._awaitingLongPress);
    }

    this.selected = false;
  },

  _onTap: function() {
    if (this.dormant) {
      return;
    }

    if (this._awaitingDoubleTap != null) {
      this.cancelAsync(this._awaitingDoubleTap);
      this._awaitingDoubleTap = null;

      this._onDoubleTap();
    } else {
      this._awaitingDoubleTap = this.async(function() {
        this._awaitingDoubleTap = null;
      }, 300);
    }
  },

  _onTrack: function() {
    if (this._awaitingLongPress != null && !this.selected) {
      this.cancelAsync(this._awaitingLongPress);
    }
  },

  _onDoubleTap: function() {
    this.edit();
  },

  _onLongPress: function() {
    this.selected = true;
  }
})
</script>
