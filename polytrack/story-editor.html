<link rel="import" href="card-editing-animation.html">
<link rel="import" href="story-card.html">
<dom-module id="story-editor">
  <style>
    #editor {
      display: block;
      position: relative;
      box-sizing: border-box;
      height: 100%;
      height: 100%;
      padding: 1em;
    }

    #editor > * {
      display: block;
      position: absolute;
      padding: 1em;
      box-sizing: border-box;
      top: 1em;
      bottom: 1em;
    }

    #input {
      left: 1em;
      right: 50%;
      background-color: #fff;
      border-radius: 2px;
      @apply(--shadow-elevation-2dp);
      margin-right: 0.5em;
    }

    #card {
      left: 50%;
      right: 1em;
      margin-left: 0.5em;
      margin-bottom: 0;
    }

    iron-autogrow-textarea {
      font-family: Menlo, Courier, monospace;
      box-sizing: border-box;
      width: 100%;
      height: 100%;
      border: 0;
    }

    paper-fab {
      display: block;
      position: absolute;
      bottom: 2em;
      right: 2em;
      z-index: 1;
    }
  </style>
  <template>

    <section id="editor">
      <div id="input">
        <iron-autogrow-textarea
          id="textarea"
          bind-value="{{story.markdown}}">
        </iron-autogrow-textarea>
      </div>
      <story-card
        id="card"
        firebase-name="[[firebaseName]]"
        card="[[_cardForStory(storyId, lastStoryId)]]"
        story="{{story}}"
        dormant>
      </story-card>
    </section>
    <paper-fab id="closeButton" icon="check" on-tap="close"></paper-fab>
  </template>
</dom-module>
<script>
Polymer({
  is: 'story-editor',

  behaviors: [
    Polymer.NeonSharedElementAnimatableBehavior
  ],

  properties: {
    firebaseName: {
      type: String
    },

    storyId: {
      type: String,
      notify: true,
      observer: '_storyIdChanged'
    },

    lastStoryId: {
      type: String,
      notify: true
    },

    story: {
      type: Object
    },

    sharedElements: {
      type: Object,
      value: function() {
        return {
          'card': this.$.card
        }
      }
    },

    animationConfig: {
      type: Object,
      value: function() {
        return {
          'entry': [{
            name: 'card-editing-animation',
            id: 'card',
            toPage: this
          }, {
            name: 'transform-animation',
            node: this.$.input,
            transformFrom: 'translateX(-10vw)',
            transformTo: 'translateX(0vw)',
            timing: {
              delay: 150
            }
          }, {
            name: 'fade-in-animation',
            node: this.$.input,
            timing: {
              delay: 150
            }
          }, {
            name: 'fade-in-animation',
            node: this.$.closeButton,
            timing: {
              delay: 0
            }
          }],
          'exit': [{
            name: 'transform-animation',
            node: this.$.input,
            transformFrom: 'translateX(0vw)',
            transformTo: 'translateX(-5vw)'
          }, {
            name: 'fade-out-animation',
            node: this.$.input
          }, {
            name: 'transform-animation',
            node: this.$.card,
            transformFrom: 'translateX(0vw)',
            transformTo: 'translateX(-5vw)',
            timing: {
              delay: 100
            }
          }, {
            name: 'fade-out-animation',
            node: this.$.card,
            timing: {
              delay: 100
            }
          }, {
            name: 'fade-out-animation',
            node: this.$.closeButton
          }]
        };
      }
    }
  },

  close: function() {
    this.fire('editing-complete');
  },

  _cardForStory: function(storyId, lastStoryId) {
    console.log('Computing new card', arguments);
    return {
      story: storyId || lastStoryId
    };
  },

  _storyLocation: function(firebaseName, storyId) {
    return 'https://' + firebaseName + '.firebaseio.com/stories/' + storyId;
  },

  _storyIdChanged: function(storyId, oldStoryId) {
    console.log('Story id changed', arguments);
    if (storyId) {
      this.$.textarea.focus();

      if (!this.lastStoryId) {
        this.lastStoryId = storyId;
      }
    } else {
      this.lastStoryId = oldStoryId;
    }
  }
});
</script>
